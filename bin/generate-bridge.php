#!/usr/bin/env php
<?php
/**
 * Sentinel Bridge Generator
 *
 * This script runs after composer install/update and generates
 * the bridge command file in the engine's Commands directory.
 */

$projectRoot = getcwd();
$vendorDir = $projectRoot . '/vendor';

$bridgeTemplate = <<<'PHP'
<?php

declare(strict_types=1);

namespace Luxid\Console\Commands;

use Luxid\Console\Command;

/**
 * Bridge command for Sentinel installation.
 *
 * THIS FILE IS AUTOMATICALLY GENERATED - DO NOT EDIT
 * Generated by luxid/sentinel package
 */
class SentinelInstallBridge extends Command
{
    protected string $description = 'Install Sentinel authentication package';

    public function handle(array $argv): int
    {
        // This file is a direct bridge that includes the actual InstallCommand
        // It's generated by the Sentinel package during installation

        $installCommandFile = __DIR__ . '/../../../../luxid/sentinel/src/Console/InstallCommand.php';

        if (!file_exists($installCommandFile)) {
            $this->error('Sentinel InstallCommand not found at: ' . $installCommandFile);
            return 1;
        }

        // Include the file directly
        require_once $installCommandFile;

        // Create the command instance
        $command = new \Luxid\Sentinel\Console\InstallCommand();

        try {
            return $command->handle($argv);
        } catch (\Throwable $e) {
            $this->error('Failed to run install command: ' . $e->getMessage());
            return 1;
        }
    }
}
PHP;

$targetFile = $vendorDir . '/luxid/engine/Engine/Console/Commands/SentinelInstallBridge.php';

// Ensure the directory exists
if (!is_dir(dirname($targetFile))) {
    mkdir(dirname($targetFile), 0755, true);
}

// Write the bridge file
if (file_put_contents($targetFile, $bridgeTemplate)) {
    echo "✅ Generated Sentinel bridge command in engine\n";
    exit(0);
} else {
    echo "❌ Failed to generate Sentinel bridge command\n";
    exit(1);
}
