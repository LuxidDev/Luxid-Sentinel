#!/usr/bin/env php
<?php
/**
 * Sentinel Bridge Generator
 *
 * This script runs after composer install/update and generates
 * the bridge command file in the engine's Commands directory.
 */

$projectRoot = getcwd();
$vendorDir = $projectRoot . '/vendor';

$bridgeTemplate = <<<'PHP'
<?php

declare(strict_types=1);

namespace Luxid\Console\Commands;

use Luxid\Console\Command;

/**
 * Bridge command for Sentinel installation.
 *
 * THIS FILE IS AUTOMATICALLY GENERATED - DO NOT EDIT
 * Generated by luxid/sentinel package
 */
class SentinelInstallBridge extends Command
{
    protected string $description = 'Install Sentinel authentication package';

    public function handle(array $argv): int
    {
        // Try to use autoloading first
        if (class_exists('\\Luxid\\Sentinel\\Console\\InstallCommand')) {
            try {
                $command = new \Luxid\Sentinel\Console\InstallCommand();
                return $command->handle($argv);
            } catch (\Throwable $e) {
                $this->error('Failed to run install command: ' . $e->getMessage());
                return 1;
            }
        }

        // Fallback to direct file inclusion
        $installCommandFile = __DIR__ . '/../../../../luxid/sentinel/src/Console/InstallCommand.php';

        if (!file_exists($installCommandFile)) {
            $this->error('Sentinel InstallCommand not found.');
            $this->line('');
            $this->line('Make sure luxid/sentinel is installed:');
            $this->line('  composer require luxid/sentinel');
            $this->line('');
            $this->line('Searched at: ' . $installCommandFile);
            return 1;
        }

        require_once $installCommandFile;

        if (!class_exists('\\Luxid\\Sentinel\\Console\\InstallCommand')) {
            $this->error('InstallCommand class not found after including file.');
            return 1;
        }

        try {
            $command = new \Luxid\Sentinel\Console\InstallCommand();
            return $command->handle($argv);
        } catch (\Throwable $e) {
            $this->error('Failed to run install command: ' . $e->getMessage());
            return 1;
        }
    }
}
PHP;

$targetFile = $vendorDir . '/luxid/engine/Engine/Console/Commands/SentinelInstallBridge.php';

// Ensure the directory exists
$targetDir = dirname($targetFile);
if (!is_dir($targetDir)) {
    if (!mkdir($targetDir, 0755, true)) {
        echo "❌ Failed to create directory: $targetDir\n";
        exit(1);
    }
    echo "✓ Created directory: $targetDir\n";
}

// Write the bridge file
if (file_put_contents($targetFile, $bridgeTemplate)) {
    echo "✅ Generated Sentinel bridge command in engine\n";
    echo "   File: $targetFile\n";
    exit(0);
} else {
    echo "❌ Failed to generate Sentinel bridge command\n";
    exit(1);
}
